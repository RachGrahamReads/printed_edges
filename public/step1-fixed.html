<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 1 - Fixed SQL Commands</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .sql-block { background: #1f2937; color: #f9fafb; padding: 20px; border-radius: 6px; position: relative; font-family: 'Monaco', 'Menlo', monospace; font-size: 14px; overflow-x: auto; }
        .copy-btn { position: absolute; top: 10px; right: 10px; background: #4f46e5; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .copy-btn:hover { background: #3730a3; }
        .warning { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin: 15px 0; }
    </style>
</head>
<body>
    <h1>üîß Step 1 - Fixed SQL Commands</h1>

    <div class="warning">
        <strong>‚ö†Ô∏è Fixed Version:</strong> This handles existing tables and constraints properly.
    </div>

    <h3>Step 1: Base Schema & Extensions (Fixed)</h3>
    <div class="sql-block">
        <button class="copy-btn" onclick="copyToClipboard(this.nextElementSibling)">Copy</button>
        <pre>-- Enable required extensions
CREATE EXTENSION IF NOT EXISTS "pg_graphql" WITH SCHEMA "graphql";
CREATE EXTENSION IF NOT EXISTS "pg_stat_statements" WITH SCHEMA "extensions";
CREATE EXTENSION IF NOT EXISTS "pgcrypto" WITH SCHEMA "extensions";
CREATE EXTENSION IF NOT EXISTS "supabase_vault" WITH SCHEMA "vault";
CREATE EXTENSION IF NOT EXISTS "uuid-ossp" WITH SCHEMA "extensions";

-- Create base tables (skip if they already exist)
CREATE TABLE IF NOT EXISTS "public"."books" (
    "id" "uuid" DEFAULT "gen_random_uuid"() NOT NULL,
    "user_id" "uuid" DEFAULT "gen_random_uuid"() NOT NULL,
    "pdf_url" "text",
    "edge_image_url" "text",
    "position" "text",
    "mode" "text",
    "status" "text",
    "output_pdf_url" "text",
    "created_at" timestamp without time zone DEFAULT "now"()
);

CREATE TABLE IF NOT EXISTS "public"."users" (
    "id" "uuid" DEFAULT "auth"."uid"() NOT NULL,
    "email" "text",
    "name" "text",
    "subscription_status" "text",
    "created_at" timestamp with time zone DEFAULT "now"() NOT NULL,
    "last_login" timestamp without time zone
);

-- Add constraints only if they don't exist
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'books_pkey') THEN
        ALTER TABLE ONLY "public"."books" ADD CONSTRAINT "books_pkey" PRIMARY KEY ("id");
    END IF;

    IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'users_pkey') THEN
        ALTER TABLE ONLY "public"."users" ADD CONSTRAINT "users_pkey" PRIMARY KEY ("id");
    END IF;
END $$;

-- Enable RLS
ALTER TABLE "public"."books" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "public"."users" ENABLE ROW LEVEL SECURITY;</pre>
    </div>

    <p><strong>‚úÖ This version:</strong></p>
    <ul>
        <li>Checks if constraints already exist before adding them</li>
        <li>Uses <code>IF NOT EXISTS</code> for tables</li>
        <li>Won't throw errors on existing database objects</li>
    </ul>

    <p><a href="/supabase-migrations.html">‚Üê Back to full migration guide</a></p>

    <script>
        function copyToClipboard(element) {
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = element.previousElementSibling;
                btn.textContent = 'Copied!';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.textContent = 'Copy';
                    btn.style.background = '#4f46e5';
                }, 2000);
            });
        }
    </script>
</body>
</html>