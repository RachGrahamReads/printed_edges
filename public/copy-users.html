<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copy Auth Users to Public Users Table</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .sql-block { background: #1f2937; color: #f9fafb; padding: 20px; border-radius: 6px; position: relative; font-family: 'Monaco', 'Menlo', monospace; font-size: 14px; overflow-x: auto; margin: 15px 0; }
        .copy-btn { position: absolute; top: 10px; right: 10px; background: #4f46e5; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .copy-btn:hover { background: #3730a3; }
        .warning { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin: 15px 0; }
        .success { background: #d1fae5; border-left: 4px solid #10b981; padding: 15px; margin: 15px 0; }
        .info { background: #dbeafe; border-left: 4px solid #3b82f6; padding: 15px; margin: 15px 0; }
    </style>
</head>
<body>
    <h1>üë• Copy Auth Users to Public Users Table</h1>

    <div class="info">
        <strong>‚ÑπÔ∏è Purpose:</strong> This will copy all existing authenticated users from <code>auth.users</code> into your <code>public.users</code> table so your application can access user data properly.
    </div>

    <h3>Step 1: Check Current Users</h3>
    <p>First, let's see what users exist in auth.users:</p>
    <div class="sql-block">
        <button class="copy-btn" onclick="copyToClipboard(this.nextElementSibling)">Copy</button>
        <pre>-- Check existing users in auth.users
SELECT id, email, created_at, email_confirmed_at, last_sign_in_at
FROM auth.users
ORDER BY created_at DESC;</pre>
    </div>

    <h3>Step 2: Check Current Public Users</h3>
    <p>Check what's currently in public.users:</p>
    <div class="sql-block">
        <button class="copy-btn" onclick="copyToClipboard(this.nextElementSibling)">Copy</button>
        <pre>-- Check existing users in public.users
SELECT id, email, name, created_at, is_admin
FROM public.users
ORDER BY created_at DESC;</pre>
    </div>

    <h3>Step 3: Copy Auth Users to Public Users</h3>
    <div class="warning">
        <strong>‚ö†Ô∏è Important:</strong> This will copy users from auth.users to public.users. Run this only once to avoid duplicates.
    </div>

    <div class="sql-block">
        <button class="copy-btn" onclick="copyToClipboard(this.nextElementSibling)">Copy</button>
        <pre>-- Copy users from auth.users to public.users
INSERT INTO public.users (id, email, name, created_at, last_login)
SELECT
    u.id,
    u.email,
    COALESCE(u.raw_user_meta_data->>'full_name', u.raw_user_meta_data->>'name', split_part(u.email, '@', 1)) as name,
    u.created_at,
    u.last_sign_in_at
FROM auth.users u
WHERE u.id NOT IN (
    -- Only insert users that don't already exist in public.users
    SELECT id FROM public.users
)
AND u.email_confirmed_at IS NOT NULL  -- Only confirmed users
ORDER BY u.created_at;</pre>
    </div>

    <h3>Step 4: Verify the Copy</h3>
    <p>Check that users were copied successfully:</p>
    <div class="sql-block">
        <button class="copy-btn" onclick="copyToClipboard(this.nextElementSibling)">Copy</button>
        <pre>-- Verify users were copied
SELECT
    'auth.users' as table_name,
    COUNT(*) as user_count
FROM auth.users
WHERE email_confirmed_at IS NOT NULL

UNION ALL

SELECT
    'public.users' as table_name,
    COUNT(*) as user_count
FROM public.users;</pre>
    </div>

    <h3>Step 5: Set Admin Users (Optional)</h3>
    <p>If you need to set specific users as admins, update their records:</p>
    <div class="sql-block">
        <button class="copy-btn" onclick="copyToClipboard(this.nextElementSibling)">Copy</button>
        <pre>-- Set specific users as admin (replace with actual email addresses)
UPDATE public.users
SET is_admin = true
WHERE email IN (
    'your-admin-email@example.com'
    -- Add more admin emails as needed
);</pre>
    </div>

    <h3>Step 6: Create User Credits Records</h3>
    <p>Create initial credit records for all copied users:</p>
    <div class="sql-block">
        <button class="copy-btn" onclick="copyToClipboard(this.nextElementSibling)">Copy</button>
        <pre>-- Create user_credits records for all users who don't have them
INSERT INTO public.user_credits (user_id, total_credits, used_credits)
SELECT
    u.id,
    0 as total_credits,  -- Start with 0 credits
    0 as used_credits
FROM public.users u
WHERE u.id NOT IN (
    SELECT user_id FROM public.user_credits WHERE user_id IS NOT NULL
);</pre>
    </div>

    <div class="success">
        <strong>‚úÖ Complete!</strong> Your auth users should now be copied to the public.users table with corresponding credit records.
    </div>

    <p><a href="/supabase-migrations.html">‚Üê Back to migration guide</a></p>

    <script>
        function copyToClipboard(element) {
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = element.previousElementSibling;
                btn.textContent = 'Copied!';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.textContent = 'Copy';
                    btn.style.background = '#4f46e5';
                }, 2000);
            });
        }
    </script>
</body>
</html>